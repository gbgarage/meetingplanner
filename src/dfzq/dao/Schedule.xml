<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap
        PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
        "http://ibatis.apache.org/dtd/sql-map-2.dtd">
        
<sqlMap>

 <resultMap id="scheduleMap" class="dfzq.model.Schedule">
    <result property="id" column="id"/>
    <result property="subject" column="subject"/>
    <result property="location" column="Venue"/>
    <result property="description" column="description"/>
    <result property="startTime" column="startTime"/>
    <result property="endTime" column="endTime"/>
    <result property="isAllDayEvent" column="isAllDayEvent"/>
    <result property="color" column="color"/>
    <result property="recurringRule" column="recurringRule"/>
</resultMap> 

 <resultMap id="scheduleByDVTMap" class="dfzq.model.ScheduleByDVT">
    <result property="meetingDate" column="Meeting_Dt"/>
    <result property="meetingTime" column="Meeting_Tm"/>
    <result property="venue" column="Venue"/>
    <result property="meetingId" column="Meeting_Id"/>
    <result property="subject" column="Subject"/>
    <result property="description" column="Description"/>
    <result property="color" column="Color"/>
</resultMap> 


    <typeAlias alias="Schedule" type="com.dfzq.model.Schedule"/>

    <insert id="addSchedule">
       insert into `tbl_schedule` (`subject`, `starttime`, `endtime`, `isalldayevent`) 
       values (#subject#, #startTime#, #endTime#, #isAllDayEvent#)
       <selectKey keyProperty="id" resultClass="java.lang.Integer" type="post" >
          SELECT LAST_INSERT_ID()
       </selectKey>
    </insert>
    
    <insert id="addDetailedSchedule">
       insert into `tbl_schedule` (`subject`, `starttime`, `endtime`, `isalldayevent`, `description`, `venue`, `color`)
       values (#subject#, #startTime#, #endTime#, #isAllDayEvent#, #description#, #location#, #color#)
       <selectKey keyProperty="id" resultClass="java.lang.Integer" type="post" >
          SELECT LAST_INSERT_ID()
       </selectKey>
    </insert>
    
    <select id="listScheduleByRange"  resultMap="scheduleMap" parameterClass="Map">
       select * from `tbl_schedule` 
       where starttime between #st# and #et#;
    </select>
    
    
    <select id="listSchedule"  resultMap="scheduleMap" parameterClass="Map">
       select * from `tbl_schedule` 
       where id = #id#;
    </select>
    
    <update id="updateSchedule">
       update `tbl_schedule` set 
          `starttime` = #startTime#, 
          `endtime` = #endTime# 
       where `id` = #id#
    </update>
    
    <delete id="removeSchedule">
       delete from `tbl_schedule` 
       where `id` = #id#
    </delete>
    
    <update id="updateDetailedSchedule">
       update `tbl_schedule` set
          `starttime`=#startTime#,
	      `endtime`=#endTime#,
          `subject`=#subject#,
		  `isalldayevent`=#isAllDayEvent#, 
           `description`=#description#,
		   `venue`=#location#,
           `color`=#color# 
        where `id`= #id#
    </update>
    
    <select id="listScheduleByDVT" resultMap="scheduleByDVTMap"  parameterClass="Map">
    SELECT
       form.Meeting_Dt,
       form.Meeting_Tm,
       form.Venue,
       form.Meeting_Id,
       s.Subject,
       s.Description,
       s.Color
  FROM (SELECT MAX(Meeting_Id) AS Meeting_Id, Meeting_Dt, Meeting_Tm, Venue
          FROM ((SELECT MAX(Id) AS Meeting_Id,
                        date_format(StartTime, '%Y%m%d') AS Meeting_Dt,
                        time_format(StartTime, '%H%i') AS Meeting_Tm,
                        venue As Venue
                   FROM schedule_system . tbl_schedule
                  WHERE time_format(StartTime, '%H%i') IN
                        ('0900','1000','1100','1200','1330','1430','1530','1630')
                  GROUP BY venue,
                           date_format(StartTime, '%Y%m%d'),
                           time_format(StartTime, '%H%i')) UNION ALL
                (SELECT NULL AS Meeting_Id, Meeting_Dt, Meeting_Tm, Venue
                   FROM (SELECT DISTINCT date_format(StartTime, '%Y%m%d') AS Meeting_Dt, Venue
                           FROM schedule_system.tbl_schedule
                          WHERE time_format(StartTime, '%H%i') IN
                                ('0900','1000','1100','1200','1330','1430','1530','1630')) d,
                        (SELECT DISTINCT time_format(StartTime, '%H%i') AS Meeting_Tm
                           FROM schedule_system . tbl_schedule
                          WHERE time_format(StartTime, '%H%i') IN
                               ('0900','1000','1100','1200','1330','1430','1530','1630')) t)) M
         GROUP BY Meeting_Dt, Meeting_Tm, Venue) form
  LEFT JOIN schedule_system.tbl_schedule s
    ON form.Meeting_Id = s.Id
 ORDER BY form.Meeting_Dt, form.Venue, form.Meeting_Tm
    </select>
</sqlMap>

